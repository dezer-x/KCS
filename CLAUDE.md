# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Laravel 12 + React + Inertia.js application for a competitive gaming platform (appears to be CS2/Counter-Strike 2 related) with matchmaking, team management, friends system, and leaderboards. The project uses:

- **Backend**: Laravel 12 with PHP 8.2+
- **Frontend**: React 19 with TypeScript, Inertia.js for SPA navigation
- **Styling**: Tailwind CSS 4 with Radix UI components
- **Authentication**: Steam OAuth via Laravel Socialite
- **Testing**: Pest PHP for backend tests
- **Build Tool**: Vite 7

## Development Commands

### Starting Development Environment
```bash
# Full development stack (server + queue + logs + vite)
composer dev

# SSR development (server + queue + logs + SSR)
composer dev:ssr
```

### Frontend Development
```bash
# Start Vite dev server only
npm run dev

# Build for production
npm run build

# Build with SSR
npm run build:ssr

# Type checking (TypeScript)
npm run types

# Linting
npm run lint

# Format code
npm run format

# Check formatting
npm run format:check
```

### Backend Development
```bash
# Run Laravel server only
php artisan serve

# Run queue worker
php artisan queue:listen --tries=1

# View logs in real-time
php artisan pail --timeout=0

# Start SSR server (after building)
php artisan inertia:start-ssr

# Code formatting (Laravel Pint)
./vendor/bin/pint
```

### Testing
```bash
# Run all tests
composer test
# Or directly:
php artisan test

# Run Pest tests
./vendor/bin/pest

# Run specific test file
php artisan test tests/Unit/CountryDetectionServiceTest.php
```

### Database
```bash
# Run migrations
php artisan migrate

# Fresh migration with seeding
php artisan migrate:fresh --seed

# Rollback migration
php artisan migrate:rollback
```

## Architecture

### Backend Structure

#### Controllers (`app/Http/Controllers/`)
- **Auth/SteamController**: Steam OAuth authentication flow with country detection
- **CountrySelectionController**: Handles mandatory one-time country selection for new users
- **MatchmakingController**: Core matchmaking logic including teams, invitations, queue, and challenges
- **FriendsController**: Friend system with add/accept/reject/block/unblock functionality
- **PracticeController**: Practice server management
- **ProfileController**: User profile management
- **LeaderboardController**: ELO-based leaderboards
- **Admin/***: Admin panel controllers for matchmaking, bans, servers

#### Models (`app/Models/`)
Key models with relationships:
- **User**: Core user model with Steam fields, ELO, bans, country, role (user/admin)
- **Team**: Matchmaking teams with ELO, members, match state
- **GameMatch**: Match records with teams, results, server details
- **MatchmakingTeam**: Team management with leader, members, invitations
- **MatchmakingInvitation**: Team invitation system
- **TeamChallengeRequest**: Direct team vs team challenges
- **Friend**: Friend relationships with status (pending/accepted/blocked)
- **PracticeServer**: Practice server pool

#### Services (`app/Services/`)
- **CountryDetectionService**: IP-based country detection using ipapi.co
- **MatchApiService**: External match API integration
- **TeamApiService**: External team API integration
- **ServerConnectionService**: Game server connection management
- **MatchmakingTeamService**: Team business logic

#### Middleware (`app/Http/Middleware/`)
- **banned**: Redirects banned users to /banned page
- Standard Laravel auth middleware

### Frontend Structure

#### Pages (`resources/js/pages/`)
Inertia.js page components (auto-resolved from controller Inertia::render calls):
- **welcome.tsx**: Landing/home page
- **Matchmaking.tsx**: Main matchmaking interface (largest component ~99KB)
- **Friends.tsx**: Friends management interface (~70KB)
- **profile.tsx**: User profile page (~82KB)
- **leaderboard.tsx**: ELO leaderboard
- **Practice.tsx**: Practice server interface
- **country-selection.tsx**: One-time country selection flow
- **BannedError.tsx**: Ban notification page
- **Admin/**: Admin panel pages

#### Components (`resources/js/components/`)
Reusable React components including:
- CountrySelector, CountryDisplay
- Various UI components (likely Radix UI based)

#### Layouts (`resources/js/layouts/`)
- **app-layout.tsx**: Main authenticated layout
- **auth-layout.tsx**: Authentication pages layout
- **app/app-header-layout.tsx**: Header component
- **app/app-sidebar-layout.tsx**: Sidebar navigation

#### Actions (`resources/js/actions/`)
TypeScript action files that mirror backend controller structure - these are auto-generated by Laravel Wayfinder for type-safe routing from React to Laravel endpoints.

#### Routing
- Uses Laravel Wayfinder for type-safe frontend route generation
- Routes defined in `routes/web.php`, `routes/admin.php`, `routes/auth.php`, `routes/settings.php`
- Inertia.js pages auto-resolved from `resources/js/pages/` directory

### Key Features

#### Steam Authentication Flow
1. User clicks Steam login → redirected to Steam OAuth
2. Steam callback → user authenticated and profile data saved
3. Check if user has country set → if not, redirect to country selection
4. Country selection is mandatory and permanent (cannot be changed)
5. Check if user is banned → redirect to /banned page
6. Finally redirect to main application

#### Matchmaking System
- **Team Creation**: Users create/join teams (up to 5 players)
- **Invitations**: Team leaders invite friends
- **Queue System**: Teams join queue for automatic matchmaking
- **Direct Challenges**: Teams can challenge other teams directly
- **Match State**: Teams track ready state, connection status, match results
- **ELO System**: Users and teams have ELO ratings updated after matches
- **Cooldowns**: Teams have cooldowns after matches

#### Friends System
- Send/accept/reject friend requests
- Block/unblock users
- View friends for matchmaking invitations
- Friend status: pending/accepted/blocked

## Code Style & Quality

### PHP
- Follow Laravel conventions
- Use Laravel Pint for formatting (PSR-12 based)
- Type hints and return types required
- Use Eloquent relationships and query builder

### TypeScript/React
- **Formatting**: Prettier with custom config
  - 4 space indentation (2 for YAML)
  - Single quotes
  - 150 char line width
  - Import organization via prettier-plugin-organize-imports
  - Tailwind class sorting via prettier-plugin-tailwindcss
- **Linting**: ESLint with TypeScript and React plugins
- Use functional components with hooks
- Inertia.js for SPA navigation (no manual API calls for page navigation)
- Use Radix UI components for UI primitives
- Tailwind CSS with `cn()` utility for class merging
- TypeScript strict mode

### Key Patterns
- **Inertia.js Flow**: Controllers return `Inertia::render('PageName', $data)` which renders `resources/js/pages/PageName.tsx` with props
- **Type-Safe Routing**: Use Laravel Wayfinder generated actions in `resources/js/actions/` instead of hardcoded URLs
- **Form Handling**: Use Inertia form helpers for CSRF protection and validation
- **Authentication**: All authenticated routes wrapped in `auth` and `banned` middleware
- **Authorization**: Role-based access via `role` field on User model (user/admin)

## External Dependencies

- **ipapi.co**: IP-based geolocation for country detection
- External match API and team API (URLs in Services)
- Steam Web API for authentication and profile data

## Important Notes

- Country selection is permanent - users cannot change after initial selection
- Ban system supports temporary and permanent bans with reasons
- All matchmaking operations check for existing teams and bans
- Queue system uses database for state management (no Redis required for basic setup)
- SQLite is default database (can switch to MySQL/PostgreSQL)
- SSR support available for SEO/performance (optional)